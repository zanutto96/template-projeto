<div class="generic-table-wrapper" [ngClass]="config?.cssClass">
  
  <!-- Seção de Filtros -->
  @if (config?.showFilters !== false) {
  <div class="filters-section">
    @if (filtersVisible) {
    <div class="filters-form-wrapper">
      <form [formGroup]="filtersForm" class="filters-form">
        <div class="row">
        
          <!-- Filtros por Coluna -->
          @for (column of config.columns; track column.field) {
          <div 
            class="col-md-6 col-lg-4 mb-3"
            [hidden]="column.filterable === false">
            <div class="form-group">
              <label class="col-form-label">{{ column.header }}</label>
              
              <!-- Filtro de Texto -->
              @if (column.type === 'text') {
              <input 
                class="form-control" 
                type="text" 
                [formControlName]="column.field"
                [placeholder]="'Filtrar por ' + column.header">
              }
              
              <!-- Filtro Numérico/Monetário -->
              @if (column.type === 'numeric' || column.type === 'currency') {
              <input 
                class="form-control" 
                type="number" 
                [formControlName]="column.field"
                [placeholder]="'Filtrar por ' + column.header">
              }
              
              <!-- Filtro de Data -->
              @if (column.type === 'date') {
              <input 
                class="form-control" 
                type="date" 
                [formControlName]="column.field">
              }
              
              <!-- Filtro Booleano -->
              @if (column.type === 'boolean') {
              <select 
                class="form-control" 
                [formControlName]="column.field">
                <option value="">Todos</option>
                <option value="true">Sim</option>
                <option value="false">Não</option>
              </select>
              }
            </div>
          </div>
          }
        </div>
      </form>
    </div>
    }

    <!-- Botões de Filtro -->
    <div class="filter-actions">
      <button
        type="button"
        class="btn btn-success add-btn"
        (click)="onAddClick()">
        <i class="fas fa-plus"></i>
        <span>Adicionar</span>
      </button>

      <button
        type="button"
        class="btn btn-outline-primary filter-btn"
        (click)="toggleFilters()">
        <i class="fas fa-filter"></i>
        <span>{{ toggleFiltersLabel }}</span>
      </button>

      <button
        type="button"
        class="btn btn-outline-secondary filter-btn"
        (click)="clearFilters()">
        <i class="fas fa-times"></i>
        <span>Limpar filtros</span>
      </button>
    </div>
  </div>
  }

  <!-- Tabela -->
  <div class="table-wrapper table-responsive">
    <table 
      mat-table 
      matSort 
      [dataSource]="dataSource" 
      class="table table-borderless table-sm generic-table">
      
      <!-- Coluna de Seleção -->
      @if (config?.selectable) {
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            (change)="toggleAllRows()"
            [checked]="isAllSelected()"
            [indeterminate]="isSomeSelected()">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="toggleRowSelection(row)"
            [checked]="isRowSelected(row)">
          </mat-checkbox>
        </td>
      </ng-container>
      }

      <!-- Colunas Dinâmicas -->
      @for (column of config.columns; track column.field) {
      <ng-container [matColumnDef]="column.field">
        <th 
          mat-header-cell 
          *matHeaderCellDef 
          [mat-sort-header]="column.sortable !== false ? column.field : ''"
          [style.width]="column.width">
          {{ column.header }}
        </th>
        <td 
          mat-cell 
          *matCellDef="let row" 
          [ngClass]="column.cssClass"
          (click)="onRowClick(row)">
          
          <!-- Texto -->
          @if (column.type === 'text') {
          <span>
            {{ getColumnValue(row, column) }}
          </span>
          }

          <!-- Numérico -->
          @if (column.type === 'numeric') {
          <span>
            {{ getColumnValue(row, column) | number }}
          </span>
          }

          <!-- Monetário -->
          @if (column.type === 'currency') {
          <span class="currency-value">
            {{ formatCurrency(getColumnValue(row, column), column) }}
          </span>
          }

          <!-- Data -->
          @if (column.type === 'date') {
          <span>
            {{ formatDate(getColumnValue(row, column), column) }}
          </span>
          }

          <!-- Checkbox -->
          @if (column.type === 'checkbox') {
          <mat-checkbox 
            [checked]="getColumnValue(row, column)"
            [disabled]="true">
          </mat-checkbox>
          }

          <!-- Booleano -->
          @if (column.type === 'boolean') {
          <span class="boolean-badge">
            <span class="badge" [ngClass]="getColumnValue(row, column) ? 'badge-success' : 'badge-secondary'">
              {{ getColumnValue(row, column) ? 'Sim' : 'Não' }}
            </span>
          </span>
          }

          <!-- Progresso -->
          @if (column.type === 'progress') {
          <div class="progress-wrapper">
            <div class="progress">
              <div 
                class="progress-bar" 
                role="progressbar" 
                [style.width.%]="getColumnValue(row, column)"
                [style.background-color]="column.config?.progressColor"
                [attr.aria-valuenow]="getColumnValue(row, column)" 
                aria-valuemin="0" 
                aria-valuemax="100">
                @if (column.config?.showLabel !== false) {
                <span>
                  {{ getColumnValue(row, column) }}%
                </span>
                }
              </div>
            </div>
          </div>
          }

          <!-- Miniatura -->
          @if (column.type === 'thumbnail') {
          <div class="thumbnail-wrapper">
            <div class="thumbnail-image-wrapper">
              <cc-aspect-ratio [ratio]="column.config?.aspectRatio || {w: 1, h: 1}">
                <cc-image-shell 
                  animation="spinner" 
                  [src]="getColumnValue(row, column)" 
                  [alt]="column.header" 
                  class="thumbnail-image">
                </cc-image-shell>
              </cc-aspect-ratio>
            </div>
          </div>
          }

          <!-- Ações -->
          @if (column.type === 'actions') {
          <div class="actions-wrapper">
            @for (action of column.config?.actions; track action.id) {
            <button
              type="button"
              class="btn btn-sm action-btn"
              [ngClass]="action.cssClass || 'btn-outline-primary'"
              [title]="action.tooltip"
              (click)="onActionClick(action.id, row, $event)">
              <i [class]="action.icon"></i>
            </button>
            }
          </div>
          }
        </td>
      </ng-container>
      }

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr 
        mat-row 
        *matRowDef="let row; columns: displayedColumns;" 
        class="table-row"
        [class.selected]="isRowSelected(row)">
      </tr>
    </table>
  </div>

  <!-- Paginador -->
  @if (config?.paginate !== false) {
  <mat-paginator 
    [pageSize]="config?.pageSize || 10"
    [pageSizeOptions]="config?.pageSizeOptions || [5, 10, 25, 50, 100]"
    (page)="onPageChange($event)"
    showFirstLastButtons>
  </mat-paginator>
  }
</div>
